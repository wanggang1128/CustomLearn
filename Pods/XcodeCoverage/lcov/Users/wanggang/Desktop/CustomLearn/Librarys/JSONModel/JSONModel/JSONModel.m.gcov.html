<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - Coverage.info - /Users/wanggang/Desktop/CustomLearn/Librarys/JSONModel/JSONModel/JSONModel.m</title>
  <link rel="stylesheet" type="text/css" href="../../../../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../../../../index.html">top level</a> - <a href="index.html">Users/wanggang/Desktop/CustomLearn/Librarys/JSONModel/JSONModel</a> - JSONModel.m<span style="font-size: 80%;"> (source / <a href="JSONModel.m.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">Coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">11</td>
            <td class="headerCovTableEntry">659</td>
            <td class="headerCovTableEntryLo">1.7 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2019-02-19 13:48:16</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">4</td>
            <td class="headerCovTableEntry">59</td>
            <td class="headerCovTableEntryLo">6.8 %</td>
          </tr>
          <tr><td><img src="../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : //</a>
<span class="lineNum">       2 </span>            : //  JSONModel.m
<span class="lineNum">       3 </span>            : //  JSONModel
<span class="lineNum">       4 </span>            : //
<span class="lineNum">       5 </span>            : 
<span class="lineNum">       6 </span>            : #if !__has_feature(objc_arc)
<span class="lineNum">       7 </span>            : #error The JSONMOdel framework is ARC only, you can enable ARC on per file basis.
<span class="lineNum">       8 </span>            : #endif
<span class="lineNum">       9 </span>            : 
<span class="lineNum">      10 </span>            : 
<span class="lineNum">      11 </span>            : #import &lt;objc/runtime.h&gt;
<span class="lineNum">      12 </span>            : #import &lt;objc/message.h&gt;
<span class="lineNum">      13 </span>            : 
<span class="lineNum">      14 </span>            : 
<span class="lineNum">      15 </span>            : #import &quot;JSONModel.h&quot;
<span class="lineNum">      16 </span>            : #import &quot;JSONModelClassProperty.h&quot;
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : #pragma mark - associated objects names
<span class="lineNum">      19 </span>            : static const char * kMapperObjectKey;
<span class="lineNum">      20 </span>            : static const char * kClassPropertiesKey;
<span class="lineNum">      21 </span>            : static const char * kClassRequiredPropertyNamesKey;
<span class="lineNum">      22 </span>            : static const char * kIndexPropertyNameKey;
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : #pragma mark - class static variables
<span class="lineNum">      25 </span>            : static NSArray* allowedJSONTypes = nil;
<span class="lineNum">      26 </span>            : static NSArray* allowedPrimitiveTypes = nil;
<span class="lineNum">      27 </span>            : static JSONValueTransformer* valueTransformer = nil;
<span class="lineNum">      28 </span>            : static Class JSONModelClass = NULL;
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : #pragma mark - model cache
<span class="lineNum">      31 </span>            : static JSONKeyMapper* globalKeyMapper = nil;
<a name="32"><span class="lineNum">      32 </span>            : </a>
<span class="lineNum">      33 </span>            : #pragma mark - JSONModel implementation
<span class="lineNum">      34 </span><span class="lineNoCov">          0 : @implementation JSONModel</span>
<span class="lineNum">      35 </span>            : {
<span class="lineNum">      36 </span>            :     NSString* _description;
<span class="lineNum">      37 </span>            : }
<span class="lineNum">      38 </span>            : 
<a name="39"><span class="lineNum">      39 </span>            : #pragma mark - initialization methods</a>
<span class="lineNum">      40 </span>            : 
<span class="lineNum">      41 </span>            : +(void)load
<a name="42"><span class="lineNum">      42 </span>            : {</a>
<span class="lineNum">      43 </span>            :     static dispatch_once_t once;
<span class="lineNum">      44 </span><span class="lineCov"> 8623620608 :     dispatch_once(&amp;once, ^{</span>
<span class="lineNum">      45 </span>            :         // initialize all class static objects,
<span class="lineNum">      46 </span>            :         // which are common for ALL JSONModel subclasses
<span class="lineNum">      47 </span>            : 
<span class="lineNum">      48 </span><span class="lineCov"> 4311810304 :         @autoreleasepool {</span>
<span class="lineNum">      49 </span><span class="lineCov">43118103040 :             allowedJSONTypes = @[</span>
<span class="lineNum">      50 </span><span class="lineCov">25870861824 :                 [NSString class], [NSNumber class], [NSDecimalNumber class], [NSArray class], [NSDictionary class], [NSNull class], //immutable JSON classes</span>
<span class="lineNum">      51 </span><span class="lineCov">12935430912 :                 [NSMutableString class], [NSMutableArray class], [NSMutableDictionary class] //mutable JSON classes</span>
<span class="lineNum">      52 </span>            :             ];
<span class="lineNum">      53 </span>            : 
<span class="lineNum">      54 </span><span class="lineCov"> 4311810304 :             allowedPrimitiveTypes = @[</span>
<span class="lineNum">      55 </span>            :                 @&quot;BOOL&quot;, @&quot;float&quot;, @&quot;int&quot;, @&quot;long&quot;, @&quot;double&quot;, @&quot;short&quot;,
<span class="lineNum">      56 </span>            :                 @&quot;unsigned int&quot;, @&quot;usigned long&quot;, @&quot;long long&quot;, @&quot;unsigned long long&quot;, @&quot;unsigned short&quot;, @&quot;char&quot;, @&quot;unsigned char&quot;,
<span class="lineNum">      57 </span>            :                 //and some famous aliases
<span class="lineNum">      58 </span>            :                 @&quot;NSInteger&quot;, @&quot;NSUInteger&quot;,
<span class="lineNum">      59 </span>            :                 @&quot;Block&quot;
<span class="lineNum">      60 </span>            :             ];
<span class="lineNum">      61 </span>            : 
<span class="lineNum">      62 </span><span class="lineCov"> 4311810304 :             valueTransformer = [[JSONValueTransformer alloc] init];</span>
<span class="lineNum">      63 </span>            : 
<span class="lineNum">      64 </span>            :             // This is quite strange, but I found the test isSubclassOfClass: (line ~291) to fail if using [JSONModel class].
<span class="lineNum">      65 </span>            :             // somewhat related: https://stackoverflow.com/questions/6524165/nsclassfromstring-vs-classnamednsstring
<span class="lineNum">      66 </span>            :             // //; seems to break the unit tests
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span>            :             // Using NSClassFromString instead of [JSONModel class], as this was breaking unit tests, see below
<span class="lineNum">      69 </span>            :             //http://stackoverflow.com/questions/21394919/xcode-5-unit-test-seeing-wrong-class
<a name="70"><span class="lineNum">      70 </span><span class="lineCov"> 4311810304 :             JSONModelClass = NSClassFromString(NSStringFromClass(self));</span></a>
<span class="lineNum">      71 </span><span class="lineCov"> 4311810304 :         }</span>
<span class="lineNum">      72 </span><span class="lineCov"> 4311810304 :     });</span>
<a name="73"><span class="lineNum">      73 </span><span class="lineCov"> 4311810304 : }</span></a>
<span class="lineNum">      74 </span>            : 
<span class="lineNum">      75 </span>            : -(void)__setup__
<span class="lineNum">      76 </span>            : {
<span class="lineNum">      77 </span>            :     //if first instance of this model, generate the property list
<span class="lineNum">      78 </span><span class="lineNoCov">          0 :     if (!objc_getAssociatedObject(self.class, &amp;kClassPropertiesKey)) {</span>
<span class="lineNum">      79 </span><span class="lineNoCov">          0 :         [self __inspectProperties];</span>
<span class="lineNum">      80 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">      81 </span>            : 
<span class="lineNum">      82 </span>            :     //if there's a custom key mapper, store it in the associated object
<span class="lineNum">      83 </span><span class="lineNoCov">          0 :     id mapper = [[self class] keyMapper];</span>
<span class="lineNum">      84 </span><span class="lineNoCov">          0 :     if ( mapper &amp;&amp; !objc_getAssociatedObject(self.class, &amp;kMapperObjectKey) ) {</span>
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :         objc_setAssociatedObject(</span>
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :                                  self.class,</span>
<span class="lineNum">      87 </span>            :                                  &amp;kMapperObjectKey,
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :                                  mapper,</span>
<span class="lineNum">      89 </span>            :                                  OBJC_ASSOCIATION_RETAIN // This is atomic
<span class="lineNum">      90 </span>            :                                  );
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :     }</span>
<a name="92"><span class="lineNum">      92 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      93 </span>            : 
<span class="lineNum">      94 </span>            : -(id)init
<span class="lineNum">      95 </span>            : {
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :     self = [super init];</span>
<span class="lineNum">      97 </span><span class="lineNoCov">          0 :     if (self) {</span>
<span class="lineNum">      98 </span>            :         //do initial class setup
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :         [self __setup__];</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :     return self;</span>
<a name="102"><span class="lineNum">     102 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     103 </span>            : 
<span class="lineNum">     104 </span>            : -(instancetype)initWithData:(NSData *)data error:(NSError *__autoreleasing *)err
<span class="lineNum">     105 </span>            : {
<span class="lineNum">     106 </span>            :     //check for nil input
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :     if (!data) {</span>
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :         if (err) *err = [JSONModelError errorInputIsNil];</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :         return nil;</span>
<span class="lineNum">     110 </span>            :     }
<span class="lineNum">     111 </span>            :     //read the json
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :     JSONModelError* initError = nil;</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :     id obj = [NSJSONSerialization JSONObjectWithData:data</span>
<span class="lineNum">     114 </span>            :                                              options:kNilOptions
<span class="lineNum">     115 </span>            :                                                error:&amp;initError];
<span class="lineNum">     116 </span>            : 
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :     if (initError) {</span>
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :         if (err) *err = [JSONModelError errorBadJSON];</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :         return nil;</span>
<span class="lineNum">     120 </span>            :     }
<span class="lineNum">     121 </span>            : 
<span class="lineNum">     122 </span>            :     //init with dictionary
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :     id objModel = [self initWithDictionary:obj error:&amp;initError];</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :     if (initError &amp;&amp; err) *err = initError;</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :     return objModel;</span>
<a name="126"><span class="lineNum">     126 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     127 </span>            : 
<span class="lineNum">     128 </span>            : -(id)initWithString:(NSString*)string error:(JSONModelError**)err
<span class="lineNum">     129 </span>            : {
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :     JSONModelError* initError = nil;</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :     id objModel = [self initWithString:string usingEncoding:NSUTF8StringEncoding error:&amp;initError];</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :     if (initError &amp;&amp; err) *err = initError;</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :     return objModel;</span>
<a name="134"><span class="lineNum">     134 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     135 </span>            : 
<span class="lineNum">     136 </span>            : -(id)initWithString:(NSString *)string usingEncoding:(NSStringEncoding)encoding error:(JSONModelError**)err
<span class="lineNum">     137 </span>            : {
<span class="lineNum">     138 </span>            :     //check for nil input
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :     if (!string) {</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :         if (err) *err = [JSONModelError errorInputIsNil];</span>
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :         return nil;</span>
<span class="lineNum">     142 </span>            :     }
<span class="lineNum">     143 </span>            : 
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :     JSONModelError* initError = nil;</span>
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :     id objModel = [self initWithData:[string dataUsingEncoding:encoding] error:&amp;initError];</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :     if (initError &amp;&amp; err) *err = initError;</span>
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :     return objModel;</span>
<span class="lineNum">     148 </span>            : 
<a name="149"><span class="lineNum">     149 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     150 </span>            : 
<span class="lineNum">     151 </span>            : -(id)initWithDictionary:(NSDictionary*)dict error:(NSError**)err
<span class="lineNum">     152 </span>            : {
<span class="lineNum">     153 </span>            :     //check for nil input
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :     if (!dict) {</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :         if (err) *err = [JSONModelError errorInputIsNil];</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :         return nil;</span>
<span class="lineNum">     157 </span>            :     }
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span>            :     //invalid input, just create empty instance
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :     if (![dict isKindOfClass:[NSDictionary class]]) {</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :         if (err) *err = [JSONModelError errorInvalidDataWithMessage:@&quot;Attempt to initialize JSONModel object using initWithDictionary:error: but the dictionary parameter was not an 'NSDictionary'.&quot;];</span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :         return nil;</span>
<span class="lineNum">     163 </span>            :     }
<span class="lineNum">     164 </span>            : 
<span class="lineNum">     165 </span>            :     //create a class instance
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :     self = [self init];</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :     if (!self) {</span>
<span class="lineNum">     168 </span>            : 
<span class="lineNum">     169 </span>            :         //super init didn't succeed
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :         if (err) *err = [JSONModelError errorModelIsInvalid];</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :         return nil;</span>
<span class="lineNum">     172 </span>            :     }
<span class="lineNum">     173 </span>            : 
<span class="lineNum">     174 </span>            :     //check incoming data structure
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :     if (![self __doesDictionary:dict matchModelWithKeyMapper:self.__keyMapper error:err]) {</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :         return nil;</span>
<span class="lineNum">     177 </span>            :     }
<span class="lineNum">     178 </span>            : 
<span class="lineNum">     179 </span>            :     //import the data from a dictionary
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :     if (![self __importDictionary:dict withKeyMapper:self.__keyMapper validation:YES error:err]) {</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :         return nil;</span>
<span class="lineNum">     182 </span>            :     }
<span class="lineNum">     183 </span>            : 
<span class="lineNum">     184 </span>            :     //run any custom model validation
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :     if (![self validate:err]) {</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :         return nil;</span>
<span class="lineNum">     187 </span>            :     }
<span class="lineNum">     188 </span>            : 
<span class="lineNum">     189 </span>            :     //model is valid! yay!
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :     return self;</span>
<a name="191"><span class="lineNum">     191 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     192 </span>            : 
<span class="lineNum">     193 </span>            : -(JSONKeyMapper*)__keyMapper
<span class="lineNum">     194 </span>            : {
<span class="lineNum">     195 </span>            :     //get the model key mapper
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :     return objc_getAssociatedObject(self.class, &amp;kMapperObjectKey);</span>
<a name="197"><span class="lineNum">     197 </span>            : }</a>
<span class="lineNum">     198 </span>            : 
<span class="lineNum">     199 </span>            : -(BOOL)__doesDictionary:(NSDictionary*)dict matchModelWithKeyMapper:(JSONKeyMapper*)keyMapper error:(NSError**)err
<span class="lineNum">     200 </span>            : {
<span class="lineNum">     201 </span>            :     //check if all required properties are present
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :     NSArray* incomingKeysArray = [dict allKeys];</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :     NSMutableSet* requiredProperties = [self __requiredPropertyNames].mutableCopy;</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :     NSSet* incomingKeys = [NSSet setWithArray: incomingKeysArray];</span>
<span class="lineNum">     205 </span>            : 
<span class="lineNum">     206 </span>            :     //transform the key names, if necessary
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :     if (keyMapper || globalKeyMapper) {</span>
<span class="lineNum">     208 </span>            : 
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :         NSMutableSet* transformedIncomingKeys = [NSMutableSet setWithCapacity: requiredProperties.count];</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :         NSString* transformedName = nil;</span>
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span>            :         //loop over the required properties list
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :         for (JSONModelClassProperty* property in [self __properties__]) {</span>
<span class="lineNum">     214 </span>            : 
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :             transformedName = (keyMapper||globalKeyMapper) ? [self __mapString:property.name withKeyMapper:keyMapper] : property.name;</span>
<span class="lineNum">     216 </span>            : 
<span class="lineNum">     217 </span>            :             //check if exists and if so, add to incoming keys
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :             id value;</span>
<span class="lineNum">     219 </span>            :             @try {
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :                 value = [dict valueForKeyPath:transformedName];</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :             @catch (NSException *exception) {</span>
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :                 value = dict[transformedName];</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     225 </span>            : 
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :             if (value) {</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :                 [transformedIncomingKeys addObject: property.name];</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     230 </span>            : 
<span class="lineNum">     231 </span>            :         //overwrite the raw incoming list with the mapped key names
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :         incomingKeys = transformedIncomingKeys;</span>
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     234 </span>            : 
<span class="lineNum">     235 </span>            :     //check for missing input keys
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :     if (![requiredProperties isSubsetOfSet:incomingKeys]) {</span>
<span class="lineNum">     237 </span>            : 
<span class="lineNum">     238 </span>            :         //get a list of the missing properties
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :         [requiredProperties minusSet:incomingKeys];</span>
<span class="lineNum">     240 </span>            : 
<span class="lineNum">     241 </span>            :         //not all required properties are in - invalid input
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :         JMLog(@&quot;Incoming data was invalid [%@ initWithDictionary:]. Keys missing: %@&quot;, self.class, requiredProperties);</span>
<span class="lineNum">     243 </span>            : 
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :         if (err) *err = [JSONModelError errorInvalidDataWithMissingKeys:requiredProperties];</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :         return NO;</span>
<span class="lineNum">     246 </span>            :     }
<span class="lineNum">     247 </span>            : 
<span class="lineNum">     248 </span>            :     //not needed anymore
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :     incomingKeys= nil;</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :     requiredProperties= nil;</span>
<span class="lineNum">     251 </span>            : 
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :     return YES;</span>
<a name="253"><span class="lineNum">     253 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     254 </span>            : 
<span class="lineNum">     255 </span>            : -(NSString*)__mapString:(NSString*)string withKeyMapper:(JSONKeyMapper*)keyMapper
<span class="lineNum">     256 </span>            : {
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :     if (keyMapper) {</span>
<span class="lineNum">     258 </span>            :         //custom mapper
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :         NSString* mappedName = [keyMapper convertValue:string];</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :         if (globalKeyMapper &amp;&amp; [mappedName isEqualToString: string]) {</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :             mappedName = [globalKeyMapper convertValue:string];</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :         string = mappedName;</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :     } else if (globalKeyMapper) {</span>
<span class="lineNum">     265 </span>            :         //global keymapper
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :         string = [globalKeyMapper convertValue:string];</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     268 </span>            : 
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :     return string;</span>
<a name="270"><span class="lineNum">     270 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     271 </span>            : 
<span class="lineNum">     272 </span>            : -(BOOL)__importDictionary:(NSDictionary*)dict withKeyMapper:(JSONKeyMapper*)keyMapper validation:(BOOL)validation error:(NSError**)err
<span class="lineNum">     273 </span>            : {
<span class="lineNum">     274 </span>            :     //loop over the incoming keys and set self's properties
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :     for (JSONModelClassProperty* property in [self __properties__]) {</span>
<span class="lineNum">     276 </span>            : 
<span class="lineNum">     277 </span>            :         //convert key name to model keys, if a mapper is provided
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :         NSString* jsonKeyPath = (keyMapper||globalKeyMapper) ? [self __mapString:property.name withKeyMapper:keyMapper] : property.name;</span>
<span class="lineNum">     279 </span>            :         //JMLog(@&quot;keyPath: %@&quot;, jsonKeyPath);
<span class="lineNum">     280 </span>            : 
<span class="lineNum">     281 </span>            :         //general check for data type compliance
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :         id jsonValue;</span>
<span class="lineNum">     283 </span>            :         @try {
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :             jsonValue = [dict valueForKeyPath: jsonKeyPath];</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :         @catch (NSException *exception) {</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :             jsonValue = dict[jsonKeyPath];</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     289 </span>            : 
<span class="lineNum">     290 </span>            :         //check for Optional properties
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :         if (isNull(jsonValue)) {</span>
<span class="lineNum">     292 </span>            :             //skip this property, continue with next property
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :             if (property.isOptional || !validation) continue;</span>
<span class="lineNum">     294 </span>            : 
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :             if (err) {</span>
<span class="lineNum">     296 </span>            :                 //null value for required property
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :                 NSString* msg = [NSString stringWithFormat:@&quot;Value of required model key %@ is null&quot;, property.name];</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :                 JSONModelError* dataErr = [JSONModelError errorInvalidDataWithMessage:msg];</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :                 *err = [dataErr errorByPrependingKeyPathComponent:property.name];</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :             return NO;</span>
<span class="lineNum">     302 </span>            :         }
<span class="lineNum">     303 </span>            : 
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :         Class jsonValueClass = [jsonValue class];</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :         BOOL isValueOfAllowedType = NO;</span>
<span class="lineNum">     306 </span>            : 
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :         for (Class allowedType in allowedJSONTypes) {</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :             if ( [jsonValueClass isSubclassOfClass: allowedType] ) {</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :                 isValueOfAllowedType = YES;</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     311 </span>            :             }
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     313 </span>            : 
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :         if (isValueOfAllowedType==NO) {</span>
<span class="lineNum">     315 </span>            :             //type not allowed
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :             JMLog(@&quot;Type %@ is not allowed in JSON.&quot;, NSStringFromClass(jsonValueClass));</span>
<span class="lineNum">     317 </span>            : 
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :             if (err) {</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :                 NSString* msg = [NSString stringWithFormat:@&quot;Type %@ is not allowed in JSON.&quot;, NSStringFromClass(jsonValueClass)];</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :                 JSONModelError* dataErr = [JSONModelError errorInvalidDataWithMessage:msg];</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :                 *err = [dataErr errorByPrependingKeyPathComponent:property.name];</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :             return NO;</span>
<span class="lineNum">     324 </span>            :         }
<span class="lineNum">     325 </span>            : 
<span class="lineNum">     326 </span>            :         //check if there's matching property in the model
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :         if (property) {</span>
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span>            :             // check for custom setter, than the model doesn't need to do any guessing
<span class="lineNum">     330 </span>            :             // how to read the property's value from JSON
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :             if ([self __customSetValue:jsonValue forProperty:property]) {</span>
<span class="lineNum">     332 </span>            :                 //skip to next JSON key
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :                 continue;</span>
<span class="lineNum">     334 </span>            :             };
<span class="lineNum">     335 </span>            : 
<span class="lineNum">     336 </span>            :             // 0) handle primitives
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :             if (property.type == nil &amp;&amp; property.structName==nil) {</span>
<span class="lineNum">     338 </span>            : 
<span class="lineNum">     339 </span>            :                 //generic setter
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :                 if (jsonValue != [self valueForKey:property.name]) {</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :                     [self setValue:jsonValue forKey: property.name];</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     343 </span>            : 
<span class="lineNum">     344 </span>            :                 //skip directly to the next key
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :                 continue;</span>
<span class="lineNum">     346 </span>            :             }
<span class="lineNum">     347 </span>            : 
<span class="lineNum">     348 </span>            :             // 0.5) handle nils
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :             if (isNull(jsonValue)) {</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :                 if ([self valueForKey:property.name] != nil) {</span>
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :                     [self setValue:nil forKey: property.name];</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :                 continue;</span>
<span class="lineNum">     354 </span>            :             }
<span class="lineNum">     355 </span>            : 
<span class="lineNum">     356 </span>            : 
<span class="lineNum">     357 </span>            :             // 1) check if property is itself a JSONModel
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :             if ([self __isJSONModelSubClass:property.type]) {</span>
<span class="lineNum">     359 </span>            : 
<span class="lineNum">     360 </span>            :                 //initialize the property's model, store it
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :                 JSONModelError* initErr = nil;</span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :                 id value = [[property.type alloc] initWithDictionary: jsonValue error:&amp;initErr];</span>
<span class="lineNum">     363 </span>            : 
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :                 if (!value) {</span>
<span class="lineNum">     365 </span>            :                     //skip this property, continue with next property
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :                     if (property.isOptional || !validation) continue;</span>
<span class="lineNum">     367 </span>            : 
<span class="lineNum">     368 </span>            :                     // Propagate the error, including the property name as the key-path component
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :                     if((err != nil) &amp;&amp; (initErr != nil))</span>
<span class="lineNum">     370 </span>            :                     {
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :                         *err = [initErr errorByPrependingKeyPathComponent:property.name];</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :                     }</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :                     return NO;</span>
<span class="lineNum">     374 </span>            :                 }
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :                 if (![value isEqual:[self valueForKey:property.name]]) {</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :                     [self setValue:value forKey: property.name];</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     378 </span>            : 
<span class="lineNum">     379 </span>            :                 //for clarity, does the same without continue
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :                 continue;</span>
<span class="lineNum">     381 </span>            : 
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :             } else {</span>
<span class="lineNum">     383 </span>            : 
<span class="lineNum">     384 </span>            :                 // 2) check if there's a protocol to the property
<span class="lineNum">     385 </span>            :                 //  ) might or not be the case there's a built in transform for it
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :                 if (property.protocol) {</span>
<span class="lineNum">     387 </span>            : 
<span class="lineNum">     388 </span>            :                     //JMLog(@&quot;proto: %@&quot;, p.protocol);
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :                     jsonValue = [self __transform:jsonValue forProperty:property error:err];</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :                     if (!jsonValue) {</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :                         if ((err != nil) &amp;&amp; (*err == nil)) {</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :                             NSString* msg = [NSString stringWithFormat:@&quot;Failed to transform value, but no error was set during transformation. (%@)&quot;, property];</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :                             JSONModelError* dataErr = [JSONModelError errorInvalidDataWithMessage:msg];</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :                             *err = [dataErr errorByPrependingKeyPathComponent:property.name];</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :                         return NO;</span>
<span class="lineNum">     397 </span>            :                     }
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     399 </span>            : 
<span class="lineNum">     400 </span>            :                 // 3.1) handle matching standard JSON types
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :                 if (property.isStandardJSONType &amp;&amp; [jsonValue isKindOfClass: property.type]) {</span>
<span class="lineNum">     402 </span>            : 
<span class="lineNum">     403 </span>            :                     //mutable properties
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :                     if (property.isMutable) {</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :                         jsonValue = [jsonValue mutableCopy];</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :                     }</span>
<span class="lineNum">     407 </span>            : 
<span class="lineNum">     408 </span>            :                     //set the property value
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :                     if (![jsonValue isEqual:[self valueForKey:property.name]]) {</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :                         [self setValue:jsonValue forKey: property.name];</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :                     }</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :                     continue;</span>
<span class="lineNum">     413 </span>            :                 }
<span class="lineNum">     414 </span>            : 
<span class="lineNum">     415 </span>            :                 // 3.3) handle values to transform
<span class="lineNum">     416 </span>            :                 if (
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :                     (![jsonValue isKindOfClass:property.type] &amp;&amp; !isNull(jsonValue))</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :                     ||</span>
<span class="lineNum">     419 </span>            :                     //the property is mutable
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :                     property.isMutable</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :                     ||</span>
<span class="lineNum">     422 </span>            :                     //custom struct property
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :                     property.structName</span>
<span class="lineNum">     424 </span>            :                     ) {
<span class="lineNum">     425 </span>            : 
<span class="lineNum">     426 </span>            :                     // searched around the web how to do this better
<span class="lineNum">     427 </span>            :                     // but did not find any solution, maybe that's the best idea? (hardly)
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :                     Class sourceClass = [JSONValueTransformer classByResolvingClusterClasses:[jsonValue class]];</span>
<span class="lineNum">     429 </span>            : 
<span class="lineNum">     430 </span>            :                     //JMLog(@&quot;to type: [%@] from type: [%@] transformer: [%@]&quot;, p.type, sourceClass, selectorName);
<span class="lineNum">     431 </span>            : 
<span class="lineNum">     432 </span>            :                     //build a method selector for the property and json object classes
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :                     NSString* selectorName = [NSString stringWithFormat:@&quot;%@From%@:&quot;,</span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :                                               (property.structName? property.structName : property.type), //target name</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :                                               sourceClass]; //source name</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :                     SEL selector = NSSelectorFromString(selectorName);</span>
<span class="lineNum">     437 </span>            : 
<span class="lineNum">     438 </span>            :                     //check for custom transformer
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :                     BOOL foundCustomTransformer = NO;</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :                     if ([valueTransformer respondsToSelector:selector]) {</span>
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :                         foundCustomTransformer = YES;</span>
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :                     } else {</span>
<span class="lineNum">     443 </span>            :                         //try for hidden custom transformer
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :                         selectorName = [NSString stringWithFormat:@&quot;__%@&quot;,selectorName];</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :                         selector = NSSelectorFromString(selectorName);</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :                         if ([valueTransformer respondsToSelector:selector]) {</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :                             foundCustomTransformer = YES;</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     449 </span>            :                     }
<span class="lineNum">     450 </span>            : 
<span class="lineNum">     451 </span>            :                     //check if there's a transformer with that name
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :                     if (foundCustomTransformer) {</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :                         IMP imp = [valueTransformer methodForSelector:selector];</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :                         id (*func)(id, SEL, id) = (void *)imp;</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :                         jsonValue = func(valueTransformer, selector, jsonValue);</span>
<span class="lineNum">     456 </span>            : 
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :                         if (![jsonValue isEqual:[self valueForKey:property.name]])</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :                             [self setValue:jsonValue forKey:property.name];</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :                     } else {</span>
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :                         if (err) {</span>
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :                             NSString* msg = [NSString stringWithFormat:@&quot;%@ type not supported for %@.%@&quot;, property.type, [self class], property.name];</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :                             JSONModelError* dataErr = [JSONModelError errorInvalidDataWithTypeMismatch:msg];</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :                             *err = [dataErr errorByPrependingKeyPathComponent:property.name];</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :                         return NO;</span>
<span class="lineNum">     466 </span>            :                     }
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">     468 </span>            :                     // 3.4) handle &quot;all other&quot; cases (if any)
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :                     if (![jsonValue isEqual:[self valueForKey:property.name]])</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :                         [self setValue:jsonValue forKey:property.name];</span>
<span class="lineNum">     471 </span>            :                 }
<span class="lineNum">     472 </span>            :             }
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     475 </span>            : 
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :     return YES;</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     478 </span>            : 
<a name="479"><span class="lineNum">     479 </span>            : #pragma mark - property inspection methods</a>
<span class="lineNum">     480 </span>            : 
<span class="lineNum">     481 </span>            : -(BOOL)__isJSONModelSubClass:(Class)class
<span class="lineNum">     482 </span>            : {
<span class="lineNum">     483 </span>            : // http://stackoverflow.com/questions/19883472/objc-nsobject-issubclassofclass-gives-incorrect-failure
<span class="lineNum">     484 </span>            : #ifdef UNIT_TESTING
<span class="lineNum">     485 </span>            :     return [@&quot;JSONModel&quot; isEqualToString: NSStringFromClass([class superclass])];
<span class="lineNum">     486 </span>            : #else
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :     return [class isSubclassOfClass:JSONModelClass];</span>
<span class="lineNum">     488 </span>            : #endif
<span class="lineNum">     489 </span>            : }
<a name="490"><span class="lineNum">     490 </span>            : </a>
<span class="lineNum">     491 </span>            : //returns a set of the required keys for the model
<span class="lineNum">     492 </span>            : -(NSMutableSet*)__requiredPropertyNames
<span class="lineNum">     493 </span>            : {
<span class="lineNum">     494 </span>            :     //fetch the associated property names
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :     NSMutableSet* classRequiredPropertyNames = objc_getAssociatedObject(self.class, &amp;kClassRequiredPropertyNamesKey);</span>
<span class="lineNum">     496 </span>            : 
<a name="497"><span class="lineNum">     497 </span><span class="lineNoCov">          0 :     if (!classRequiredPropertyNames) {</span></a>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :         classRequiredPropertyNames = [NSMutableSet set];</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :         [[self __properties__] enumerateObjectsUsingBlock:^(JSONModelClassProperty* p, NSUInteger idx, BOOL *stop) {</span>
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :             if (!p.isOptional) [classRequiredPropertyNames addObject:p.name];</span>
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :         }];</span>
<span class="lineNum">     502 </span>            : 
<span class="lineNum">     503 </span>            :         //persist the list
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :         objc_setAssociatedObject(</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :                                  self.class,</span>
<span class="lineNum">     506 </span>            :                                  &amp;kClassRequiredPropertyNamesKey,
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :                                  classRequiredPropertyNames,</span>
<span class="lineNum">     508 </span>            :                                  OBJC_ASSOCIATION_RETAIN // This is atomic
<span class="lineNum">     509 </span>            :                                  );
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :     return classRequiredPropertyNames;</span>
<span class="lineNum">     512 </span><span class="lineNoCov">          0 : }</span>
<a name="513"><span class="lineNum">     513 </span>            : </a>
<span class="lineNum">     514 </span>            : //returns a list of the model's properties
<span class="lineNum">     515 </span>            : -(NSArray*)__properties__
<span class="lineNum">     516 </span>            : {
<span class="lineNum">     517 </span>            :     //fetch the associated object
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :     NSDictionary* classProperties = objc_getAssociatedObject(self.class, &amp;kClassPropertiesKey);</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :     if (classProperties) return [classProperties allValues];</span>
<span class="lineNum">     520 </span>            : 
<span class="lineNum">     521 </span>            :     //if here, the class needs to inspect itself
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :     [self __setup__];</span>
<span class="lineNum">     523 </span>            : 
<span class="lineNum">     524 </span>            :     //return the property list
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :     classProperties = objc_getAssociatedObject(self.class, &amp;kClassPropertiesKey);</span>
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :     return [classProperties allValues];</span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 : }</span>
<a name="528"><span class="lineNum">     528 </span>            : </a>
<span class="lineNum">     529 </span>            : //inspects the class, get's a list of the class properties
<span class="lineNum">     530 </span>            : -(void)__inspectProperties
<span class="lineNum">     531 </span>            : {
<span class="lineNum">     532 </span>            :     //JMLog(@&quot;Inspect class: %@&quot;, [self class]);
<span class="lineNum">     533 </span>            : 
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :     NSMutableDictionary* propertyIndex = [NSMutableDictionary dictionary];</span>
<span class="lineNum">     535 </span>            : 
<span class="lineNum">     536 </span>            :     //temp variables for the loops
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :     Class class = [self class];</span>
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :     NSScanner* scanner = nil;</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :     NSString* propertyType = nil;</span>
<span class="lineNum">     540 </span>            : 
<span class="lineNum">     541 </span>            :     // inspect inherited properties up to the JSONModel class
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :     while (class != [JSONModel class]) {</span>
<span class="lineNum">     543 </span>            :         //JMLog(@&quot;inspecting: %@&quot;, NSStringFromClass(class));
<span class="lineNum">     544 </span>            : 
<span class="lineNum">     545 </span>            :         unsigned int propertyCount;
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :         objc_property_t *properties = class_copyPropertyList(class, &amp;propertyCount);</span>
<span class="lineNum">     547 </span>            : 
<span class="lineNum">     548 </span>            :         //loop over the class properties
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :         for (unsigned int i = 0; i &lt; propertyCount; i++) {</span>
<span class="lineNum">     550 </span>            : 
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :             JSONModelClassProperty* p = [[JSONModelClassProperty alloc] init];</span>
<span class="lineNum">     552 </span>            : 
<span class="lineNum">     553 </span>            :             //get property name
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :             objc_property_t property = properties[i];</span>
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :             const char *propertyName = property_getName(property);</span>
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :             p.name = @(propertyName);</span>
<span class="lineNum">     557 </span>            : 
<span class="lineNum">     558 </span>            :             //JMLog(@&quot;property: %@&quot;, p.name);
<span class="lineNum">     559 </span>            : 
<span class="lineNum">     560 </span>            :             //get property attributes
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :             const char *attrs = property_getAttributes(property);</span>
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :             NSString* propertyAttributes = @(attrs);</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :             NSArray* attributeItems = [propertyAttributes componentsSeparatedByString:@&quot;,&quot;];</span>
<span class="lineNum">     564 </span>            : 
<span class="lineNum">     565 </span>            :             //ignore read-only properties
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :             if ([attributeItems containsObject:@&quot;R&quot;]) {</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :                 continue; //to next property</span>
<span class="lineNum">     568 </span>            :             }
<span class="lineNum">     569 </span>            : 
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :             scanner = [NSScanner scannerWithString: propertyAttributes];</span>
<span class="lineNum">     571 </span>            : 
<span class="lineNum">     572 </span>            :             //JMLog(@&quot;attr: %@&quot;, [NSString stringWithCString:attrs encoding:NSUTF8StringEncoding]);
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :             [scanner scanUpToString:@&quot;T&quot; intoString: nil];</span>
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :             [scanner scanString:@&quot;T&quot; intoString:nil];</span>
<span class="lineNum">     575 </span>            : 
<span class="lineNum">     576 </span>            :             //check if the property is an instance of a class
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :             if ([scanner scanString:@&quot;@\&quot;&quot; intoString: &amp;propertyType]) {</span>
<span class="lineNum">     578 </span>            : 
<span class="lineNum">     579 </span><span class="lineNoCov">          0 :                 [scanner scanUpToCharactersFromSet:[NSCharacterSet characterSetWithCharactersInString:@&quot;\&quot;&lt;&quot;]</span>
<span class="lineNum">     580 </span>            :                                         intoString:&amp;propertyType];
<span class="lineNum">     581 </span>            : 
<span class="lineNum">     582 </span>            :                 //JMLog(@&quot;type: %@&quot;, propertyClassName);
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :                 p.type = NSClassFromString(propertyType);</span>
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :                 p.isMutable = ([propertyType rangeOfString:@&quot;Mutable&quot;].location != NSNotFound);</span>
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :                 p.isStandardJSONType = [allowedJSONTypes containsObject:p.type];</span>
<span class="lineNum">     586 </span>            : 
<span class="lineNum">     587 </span>            :                 //read through the property protocols
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :                 while ([scanner scanString:@&quot;&lt;&quot; intoString:NULL]) {</span>
<span class="lineNum">     589 </span>            : 
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :                     NSString* protocolName = nil;</span>
<span class="lineNum">     591 </span>            : 
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :                     [scanner scanUpToString:@&quot;&gt;&quot; intoString: &amp;protocolName];</span>
<span class="lineNum">     593 </span>            : 
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :                     if ([protocolName isEqualToString:@&quot;Optional&quot;]) {</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :                         p.isOptional = YES;</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :                     } else if([protocolName isEqualToString:@&quot;Index&quot;]) {</span>
<span class="lineNum">     597 </span>            : #pragma GCC diagnostic push
<span class="lineNum">     598 </span>            : #pragma GCC diagnostic ignored &quot;-Wdeprecated-declarations&quot;
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :                         p.isIndex = YES;</span>
<span class="lineNum">     600 </span>            : #pragma GCC diagnostic pop
<span class="lineNum">     601 </span>            : 
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :                         objc_setAssociatedObject(</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :                                                  self.class,</span>
<span class="lineNum">     604 </span>            :                                                  &amp;kIndexPropertyNameKey,
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :                                                  p.name,</span>
<span class="lineNum">     606 </span>            :                                                  OBJC_ASSOCIATION_RETAIN // This is atomic
<span class="lineNum">     607 </span>            :                                                  );
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :                     } else if([protocolName isEqualToString:@&quot;Ignore&quot;]) {</span>
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :                         p = nil;</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :                     } else {</span>
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :                         p.protocol = protocolName;</span>
<span class="lineNum">     612 </span>            :                     }
<span class="lineNum">     613 </span>            : 
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :                     [scanner scanString:@&quot;&gt;&quot; intoString:NULL];</span>
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     616 </span>            : 
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     618 </span>            :             //check if the property is a structure
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :             else if ([scanner scanString:@&quot;{&quot; intoString: &amp;propertyType]) {</span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :                 [scanner scanCharactersFromSet:[NSCharacterSet alphanumericCharacterSet]</span>
<span class="lineNum">     621 </span>            :                                     intoString:&amp;propertyType];
<span class="lineNum">     622 </span>            : 
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :                 p.isStandardJSONType = NO;</span>
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :                 p.structName = propertyType;</span>
<span class="lineNum">     625 </span>            : 
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     627 </span>            :             //the property must be a primitive
<span class="lineNum">     628 </span>            :             else {
<span class="lineNum">     629 </span>            : 
<span class="lineNum">     630 </span>            :                 //the property contains a primitive data type
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :                 [scanner scanUpToCharactersFromSet:[NSCharacterSet characterSetWithCharactersInString:@&quot;,&quot;]</span>
<span class="lineNum">     632 </span>            :                                         intoString:&amp;propertyType];
<span class="lineNum">     633 </span>            : 
<span class="lineNum">     634 </span>            :                 //get the full name of the primitive type
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :                 propertyType = valueTransformer.primitivesNames[propertyType];</span>
<span class="lineNum">     636 </span>            : 
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :                 if (![allowedPrimitiveTypes containsObject:propertyType]) {</span>
<span class="lineNum">     638 </span>            : 
<span class="lineNum">     639 </span>            :                     //type not allowed - programmer mistaken -&gt; exception
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :                     @throw [NSException exceptionWithName:@&quot;JSONModelProperty type not allowed&quot;</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :                                                    reason:[NSString stringWithFormat:@&quot;Property type of %@.%@ is not supported by JSONModel.&quot;, self.class, p.name]</span>
<span class="lineNum">     642 </span>            :                                                  userInfo:nil];
<span class="lineNum">     643 </span>            :                 }
<span class="lineNum">     644 </span>            : 
<span class="lineNum">     645 </span>            :             }
<span class="lineNum">     646 </span>            : 
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :             NSString *nsPropertyName = @(propertyName);</span>
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :             if([[self class] propertyIsOptional:nsPropertyName]){</span>
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :                 p.isOptional = YES;</span>
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     651 </span>            : 
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :             if([[self class] propertyIsIgnored:nsPropertyName]){</span>
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :                 p = nil;</span>
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     655 </span>            : 
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :             Class customClass = [[self class] classForCollectionProperty:nsPropertyName];</span>
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :             if (customClass) {</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :                 p.protocol = NSStringFromClass(customClass);</span>
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     660 </span>            : 
<span class="lineNum">     661 </span>            :             //few cases where JSONModel will ignore properties automatically
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :             if ([propertyType isEqualToString:@&quot;Block&quot;]) {</span>
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :                 p = nil;</span>
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     665 </span>            : 
<span class="lineNum">     666 </span>            :             //add the property object to the temp index
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :             if (p &amp;&amp; ![propertyIndex objectForKey:p.name]) {</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :                 [propertyIndex setValue:p forKey:p.name];</span>
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     670 </span>            : 
<span class="lineNum">     671 </span>            :             // generate custom setters and getter
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :             if (p)</span>
<span class="lineNum">     673 </span>            :             {
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :                 NSString *name = [p.name stringByReplacingCharactersInRange:NSMakeRange(0, 1) withString:[p.name substringToIndex:1].uppercaseString];</span>
<span class="lineNum">     675 </span>            : 
<span class="lineNum">     676 </span>            :                 // getter
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :                 SEL getter = NSSelectorFromString([NSString stringWithFormat:@&quot;JSONObjectFor%@&quot;, name]);</span>
<span class="lineNum">     678 </span>            : 
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :                 if ([self respondsToSelector:getter])</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :                     p.customGetter = getter;</span>
<span class="lineNum">     681 </span>            : 
<span class="lineNum">     682 </span>            :                 // setters
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :                 p.customSetters = [NSMutableDictionary new];</span>
<span class="lineNum">     684 </span>            : 
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :                 SEL genericSetter = NSSelectorFromString([NSString stringWithFormat:@&quot;set%@WithJSONObject:&quot;, name]);</span>
<span class="lineNum">     686 </span>            : 
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :                 if ([self respondsToSelector:genericSetter])</span>
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :                     p.customSetters[@&quot;generic&quot;] = [NSValue valueWithBytes:&amp;genericSetter objCType:@encode(SEL)];</span>
<span class="lineNum">     689 </span>            : 
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :                 for (Class type in allowedJSONTypes)</span>
<span class="lineNum">     691 </span>            :                 {
<span class="lineNum">     692 </span><span class="lineNoCov">          0 :                     NSString *class = NSStringFromClass([JSONValueTransformer classByResolvingClusterClasses:type]);</span>
<span class="lineNum">     693 </span>            : 
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :                     if (p.customSetters[class])</span>
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">     696 </span>            : 
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :                     SEL setter = NSSelectorFromString([NSString stringWithFormat:@&quot;set%@With%@:&quot;, name, class]);</span>
<span class="lineNum">     698 </span>            : 
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :                     if ([self respondsToSelector:setter])</span>
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :                         p.customSetters[class] = [NSValue valueWithBytes:&amp;setter objCType:@encode(SEL)];</span>
<span class="lineNum">     701 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     704 </span>            : 
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :         free(properties);</span>
<span class="lineNum">     706 </span>            : 
<span class="lineNum">     707 </span>            :         //ascend to the super of the class
<span class="lineNum">     708 </span>            :         //(will do that until it reaches the root class - JSONModel)
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :         class = [class superclass];</span>
<span class="lineNum">     710 </span>            :     }
<span class="lineNum">     711 </span>            : 
<span class="lineNum">     712 </span>            :     //finally store the property index in the static property index
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :     objc_setAssociatedObject(</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :                              self.class,</span>
<span class="lineNum">     715 </span>            :                              &amp;kClassPropertiesKey,
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :                              [propertyIndex copy],</span>
<span class="lineNum">     717 </span>            :                              OBJC_ASSOCIATION_RETAIN // This is atomic
<span class="lineNum">     718 </span>            :                              );
<span class="lineNum">     719 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     720 </span>            : 
<a name="721"><span class="lineNum">     721 </span>            : #pragma mark - built-in transformer methods</a>
<span class="lineNum">     722 </span>            : //few built-in transformations
<span class="lineNum">     723 </span>            : -(id)__transform:(id)value forProperty:(JSONModelClassProperty*)property error:(NSError**)err
<span class="lineNum">     724 </span>            : {
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :     Class protocolClass = NSClassFromString(property.protocol);</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :     if (!protocolClass) {</span>
<span class="lineNum">     727 </span>            : 
<span class="lineNum">     728 </span>            :         //no other protocols on arrays and dictionaries
<span class="lineNum">     729 </span>            :         //except JSONModel classes
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :         if ([value isKindOfClass:[NSArray class]]) {</span>
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :             @throw [NSException exceptionWithName:@&quot;Bad property protocol declaration&quot;</span>
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :                                            reason:[NSString stringWithFormat:@&quot;&lt;%@&gt; is not allowed JSONModel property protocol, and not a JSONModel class.&quot;, property.protocol]</span>
<span class="lineNum">     733 </span>            :                                          userInfo:nil];
<span class="lineNum">     734 </span>            :         }
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :         return value;</span>
<span class="lineNum">     736 </span>            :     }
<span class="lineNum">     737 </span>            : 
<span class="lineNum">     738 </span>            :     //if the protocol is actually a JSONModel class
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :     if ([self __isJSONModelSubClass:protocolClass]) {</span>
<span class="lineNum">     740 </span>            : 
<span class="lineNum">     741 </span>            :         //check if it's a list of models
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :         if ([property.type isSubclassOfClass:[NSArray class]]) {</span>
<span class="lineNum">     743 </span>            : 
<span class="lineNum">     744 </span>            :             // Expecting an array, make sure 'value' is an array
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :             if(![[value class] isSubclassOfClass:[NSArray class]])</span>
<span class="lineNum">     746 </span>            :             {
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :                 if(err != nil)</span>
<span class="lineNum">     748 </span>            :                 {
<span class="lineNum">     749 </span><span class="lineNoCov">          0 :                     NSString* mismatch = [NSString stringWithFormat:@&quot;Property '%@' is declared as NSArray&lt;%@&gt;* but the corresponding JSON value is not a JSON Array.&quot;, property.name, property.protocol];</span>
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :                     JSONModelError* typeErr = [JSONModelError errorInvalidDataWithTypeMismatch:mismatch];</span>
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :                     *err = [typeErr errorByPrependingKeyPathComponent:property.name];</span>
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :                 return nil;</span>
<span class="lineNum">     754 </span>            :             }
<span class="lineNum">     755 </span>            : 
<span class="lineNum">     756 </span>            :             //one shot conversion
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :             JSONModelError* arrayErr = nil;</span>
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :             value = [[protocolClass class] arrayOfModelsFromDictionaries:value error:&amp;arrayErr];</span>
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :             if((err != nil) &amp;&amp; (arrayErr != nil))</span>
<span class="lineNum">     760 </span>            :             {
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :                 *err = [arrayErr errorByPrependingKeyPathComponent:property.name];</span>
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :                 return nil;</span>
<span class="lineNum">     763 </span>            :             }
<span class="lineNum">     764 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     765 </span>            : 
<span class="lineNum">     766 </span>            :         //check if it's a dictionary of models
<span class="lineNum">     767 </span><span class="lineNoCov">          0 :         if ([property.type isSubclassOfClass:[NSDictionary class]]) {</span>
<span class="lineNum">     768 </span>            : 
<span class="lineNum">     769 </span>            :             // Expecting a dictionary, make sure 'value' is a dictionary
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :             if(![[value class] isSubclassOfClass:[NSDictionary class]])</span>
<span class="lineNum">     771 </span>            :             {
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :                 if(err != nil)</span>
<span class="lineNum">     773 </span>            :                 {
<span class="lineNum">     774 </span><span class="lineNoCov">          0 :                     NSString* mismatch = [NSString stringWithFormat:@&quot;Property '%@' is declared as NSDictionary&lt;%@&gt;* but the corresponding JSON value is not a JSON Object.&quot;, property.name, property.protocol];</span>
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :                     JSONModelError* typeErr = [JSONModelError errorInvalidDataWithTypeMismatch:mismatch];</span>
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :                     *err = [typeErr errorByPrependingKeyPathComponent:property.name];</span>
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :                 return nil;</span>
<span class="lineNum">     779 </span>            :             }
<span class="lineNum">     780 </span>            : 
<span class="lineNum">     781 </span><span class="lineNoCov">          0 :             NSMutableDictionary* res = [NSMutableDictionary dictionary];</span>
<span class="lineNum">     782 </span>            : 
<span class="lineNum">     783 </span><span class="lineNoCov">          0 :             for (NSString* key in [value allKeys]) {</span>
<span class="lineNum">     784 </span><span class="lineNoCov">          0 :                 JSONModelError* initErr = nil;</span>
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :                 id obj = [[[protocolClass class] alloc] initWithDictionary:value[key] error:&amp;initErr];</span>
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :                 if (obj == nil)</span>
<span class="lineNum">     787 </span>            :                 {
<span class="lineNum">     788 </span>            :                     // Propagate the error, including the property name as the key-path component
<span class="lineNum">     789 </span><span class="lineNoCov">          0 :                     if((err != nil) &amp;&amp; (initErr != nil))</span>
<span class="lineNum">     790 </span>            :                     {
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :                         initErr = [initErr errorByPrependingKeyPathComponent:key];</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :                         *err = [initErr errorByPrependingKeyPathComponent:property.name];</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :                     }</span>
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :                     return nil;</span>
<span class="lineNum">     795 </span>            :                 }
<span class="lineNum">     796 </span><span class="lineNoCov">          0 :                 [res setValue:obj forKey:key];</span>
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :             value = [NSDictionary dictionaryWithDictionary:res];</span>
<span class="lineNum">     799 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     800 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     801 </span>            : 
<span class="lineNum">     802 </span><span class="lineNoCov">          0 :     return value;</span>
<span class="lineNum">     803 </span><span class="lineNoCov">          0 : }</span>
<a name="804"><span class="lineNum">     804 </span>            : </a>
<span class="lineNum">     805 </span>            : //built-in reverse transformations (export to JSON compliant objects)
<span class="lineNum">     806 </span>            : -(id)__reverseTransform:(id)value forProperty:(JSONModelClassProperty*)property
<span class="lineNum">     807 </span>            : {
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :     Class protocolClass = NSClassFromString(property.protocol);</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :     if (!protocolClass) return value;</span>
<span class="lineNum">     810 </span>            : 
<span class="lineNum">     811 </span>            :     //if the protocol is actually a JSONModel class
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :     if ([self __isJSONModelSubClass:protocolClass]) {</span>
<span class="lineNum">     813 </span>            : 
<span class="lineNum">     814 </span>            :         //check if should export list of dictionaries
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :         if (property.type == [NSArray class] || property.type == [NSMutableArray class]) {</span>
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :             NSMutableArray* tempArray = [NSMutableArray arrayWithCapacity: [(NSArray*)value count] ];</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :             for (NSObject&lt;AbstractJSONModelProtocol&gt;* model in (NSArray*)value) {</span>
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :                 if ([model respondsToSelector:@selector(toDictionary)]) {</span>
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :                     [tempArray addObject: [model toDictionary]];</span>
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :                 } else</span>
<span class="lineNum">     821 </span><span class="lineNoCov">          0 :                     [tempArray addObject: model];</span>
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :             return [tempArray copy];</span>
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     825 </span>            : 
<span class="lineNum">     826 </span>            :         //check if should export dictionary of dictionaries
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :         if (property.type == [NSDictionary class] || property.type == [NSMutableDictionary class]) {</span>
<span class="lineNum">     828 </span><span class="lineNoCov">          0 :             NSMutableDictionary* res = [NSMutableDictionary dictionary];</span>
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :             for (NSString* key in [(NSDictionary*)value allKeys]) {</span>
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :                 id&lt;AbstractJSONModelProtocol&gt; model = value[key];</span>
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :                 [res setValue: [model toDictionary] forKey: key];</span>
<span class="lineNum">     832 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     833 </span><span class="lineNoCov">          0 :             return [NSDictionary dictionaryWithDictionary:res];</span>
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     835 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     836 </span>            : 
<span class="lineNum">     837 </span><span class="lineNoCov">          0 :     return value;</span>
<span class="lineNum">     838 </span><span class="lineNoCov">          0 : }</span>
<a name="839"><span class="lineNum">     839 </span>            : </a>
<span class="lineNum">     840 </span>            : #pragma mark - custom transformations
<span class="lineNum">     841 </span>            : - (BOOL)__customSetValue:(id &lt;NSObject&gt;)value forProperty:(JSONModelClassProperty *)property
<span class="lineNum">     842 </span>            : {
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :     NSString *class = NSStringFromClass([JSONValueTransformer classByResolvingClusterClasses:[value class]]);</span>
<span class="lineNum">     844 </span>            : 
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :     SEL setter = nil;</span>
<span class="lineNum">     846 </span><span class="lineNoCov">          0 :     [property.customSetters[class] getValue:&amp;setter];</span>
<span class="lineNum">     847 </span>            : 
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :     if (!setter)</span>
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :         [property.customSetters[@&quot;generic&quot;] getValue:&amp;setter];</span>
<span class="lineNum">     850 </span>            : 
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :     if (!setter)</span>
<span class="lineNum">     852 </span><span class="lineNoCov">          0 :         return NO;</span>
<span class="lineNum">     853 </span>            : 
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :     IMP imp = [self methodForSelector:setter];</span>
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :     void (*func)(id, SEL, id &lt;NSObject&gt;) = (void *)imp;</span>
<span class="lineNum">     856 </span><span class="lineNoCov">          0 :     func(self, setter, value);</span>
<span class="lineNum">     857 </span>            : 
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :     return YES;</span>
<a name="859"><span class="lineNum">     859 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     860 </span>            : 
<span class="lineNum">     861 </span>            : - (BOOL)__customGetValue:(id *)value forProperty:(JSONModelClassProperty *)property
<span class="lineNum">     862 </span>            : {
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :     SEL getter = property.customGetter;</span>
<span class="lineNum">     864 </span>            : 
<span class="lineNum">     865 </span><span class="lineNoCov">          0 :     if (!getter)</span>
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :         return NO;</span>
<span class="lineNum">     867 </span>            : 
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :     IMP imp = [self methodForSelector:getter];</span>
<span class="lineNum">     869 </span><span class="lineNoCov">          0 :     id (*func)(id, SEL) = (void *)imp;</span>
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :     *value = func(self, getter);</span>
<span class="lineNum">     871 </span>            : 
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :     return YES;</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 : }</span>
<a name="874"><span class="lineNum">     874 </span>            : </a>
<span class="lineNum">     875 </span>            : #pragma mark - persistance
<span class="lineNum">     876 </span>            : -(void)__createDictionariesForKeyPath:(NSString*)keyPath inDictionary:(NSMutableDictionary**)dict
<span class="lineNum">     877 </span>            : {
<span class="lineNum">     878 </span>            :     //find if there's a dot left in the keyPath
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :     NSUInteger dotLocation = [keyPath rangeOfString:@&quot;.&quot;].location;</span>
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :     if (dotLocation==NSNotFound) return;</span>
<span class="lineNum">     881 </span>            : 
<span class="lineNum">     882 </span>            :     //inspect next level
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :     NSString* nextHierarchyLevelKeyName = [keyPath substringToIndex: dotLocation];</span>
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :     NSDictionary* nextLevelDictionary = (*dict)[nextHierarchyLevelKeyName];</span>
<span class="lineNum">     885 </span>            : 
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :     if (nextLevelDictionary==nil) {</span>
<span class="lineNum">     887 </span>            :         //create non-existing next level here
<span class="lineNum">     888 </span><span class="lineNoCov">          0 :         nextLevelDictionary = [NSMutableDictionary dictionary];</span>
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     890 </span>            : 
<span class="lineNum">     891 </span>            :     //recurse levels
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :     [self __createDictionariesForKeyPath:[keyPath substringFromIndex: dotLocation+1]</span>
<span class="lineNum">     893 </span>            :                             inDictionary:&amp;nextLevelDictionary ];
<span class="lineNum">     894 </span>            : 
<span class="lineNum">     895 </span>            :     //create the hierarchy level
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :     [*dict setValue:nextLevelDictionary  forKeyPath: nextHierarchyLevelKeyName];</span>
<a name="897"><span class="lineNum">     897 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     898 </span>            : 
<span class="lineNum">     899 </span>            : -(NSDictionary*)toDictionary
<span class="lineNum">     900 </span>            : {
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :     return [self toDictionaryWithKeys:nil];</span>
<a name="902"><span class="lineNum">     902 </span>            : }</a>
<span class="lineNum">     903 </span>            : 
<span class="lineNum">     904 </span>            : -(NSString*)toJSONString
<span class="lineNum">     905 </span>            : {
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :     return [self toJSONStringWithKeys:nil];</span>
<a name="907"><span class="lineNum">     907 </span>            : }</a>
<span class="lineNum">     908 </span>            : 
<span class="lineNum">     909 </span>            : -(NSData*)toJSONData
<span class="lineNum">     910 </span>            : {
<span class="lineNum">     911 </span><span class="lineNoCov">          0 :     return [self toJSONDataWithKeys:nil];</span>
<span class="lineNum">     912 </span>            : }
<a name="913"><span class="lineNum">     913 </span>            : </a>
<span class="lineNum">     914 </span>            : //exports the model as a dictionary of JSON compliant objects
<span class="lineNum">     915 </span>            : - (NSDictionary *)toDictionaryWithKeys:(NSArray &lt;NSString *&gt; *)propertyNames
<span class="lineNum">     916 </span>            : {
<span class="lineNum">     917 </span><span class="lineNoCov">          0 :     NSArray* properties = [self __properties__];</span>
<span class="lineNum">     918 </span><span class="lineNoCov">          0 :     NSMutableDictionary* tempDictionary = [NSMutableDictionary dictionaryWithCapacity:properties.count];</span>
<span class="lineNum">     919 </span>            : 
<span class="lineNum">     920 </span><span class="lineNoCov">          0 :     id value;</span>
<span class="lineNum">     921 </span>            : 
<span class="lineNum">     922 </span>            :     //loop over all properties
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :     for (JSONModelClassProperty* p in properties) {</span>
<span class="lineNum">     924 </span>            : 
<span class="lineNum">     925 </span>            :         //skip if unwanted
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :         if (propertyNames != nil &amp;&amp; ![propertyNames containsObject:p.name])</span>
<span class="lineNum">     927 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     928 </span>            : 
<span class="lineNum">     929 </span>            :         //fetch key and value
<span class="lineNum">     930 </span><span class="lineNoCov">          0 :         NSString* keyPath = (self.__keyMapper||globalKeyMapper) ? [self __mapString:p.name withKeyMapper:self.__keyMapper] : p.name;</span>
<span class="lineNum">     931 </span><span class="lineNoCov">          0 :         value = [self valueForKey: p.name];</span>
<span class="lineNum">     932 </span>            : 
<span class="lineNum">     933 </span>            :         //JMLog(@&quot;toDictionary[%@]-&gt;[%@] = '%@'&quot;, p.name, keyPath, value);
<span class="lineNum">     934 </span>            : 
<span class="lineNum">     935 </span><span class="lineNoCov">          0 :         if ([keyPath rangeOfString:@&quot;.&quot;].location != NSNotFound) {</span>
<span class="lineNum">     936 </span>            :             //there are sub-keys, introduce dictionaries for them
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :             [self __createDictionariesForKeyPath:keyPath inDictionary:&amp;tempDictionary];</span>
<span class="lineNum">     938 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     939 </span>            : 
<span class="lineNum">     940 </span>            :         //check for custom getter
<span class="lineNum">     941 </span><span class="lineNoCov">          0 :         if ([self __customGetValue:&amp;value forProperty:p]) {</span>
<span class="lineNum">     942 </span>            :             //custom getter, all done
<span class="lineNum">     943 </span><span class="lineNoCov">          0 :             [tempDictionary setValue:value forKeyPath:keyPath];</span>
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     945 </span>            :         }
<span class="lineNum">     946 </span>            : 
<span class="lineNum">     947 </span>            :         //export nil when they are not optional values as JSON null, so that the structure of the exported data
<span class="lineNum">     948 </span>            :         //is still valid if it's to be imported as a model again
<span class="lineNum">     949 </span><span class="lineNoCov">          0 :         if (isNull(value)) {</span>
<span class="lineNum">     950 </span>            : 
<span class="lineNum">     951 </span><span class="lineNoCov">          0 :             if (value == nil)</span>
<span class="lineNum">     952 </span>            :             {
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :                 [tempDictionary removeObjectForKey:keyPath];</span>
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     955 </span>            :             else
<span class="lineNum">     956 </span>            :             {
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :                 [tempDictionary setValue:[NSNull null] forKeyPath:keyPath];</span>
<span class="lineNum">     958 </span>            :             }
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     960 </span>            :         }
<span class="lineNum">     961 </span>            : 
<span class="lineNum">     962 </span>            :         //check if the property is another model
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :         if ([value isKindOfClass:JSONModelClass]) {</span>
<span class="lineNum">     964 </span>            : 
<span class="lineNum">     965 </span>            :             //recurse models
<span class="lineNum">     966 </span><span class="lineNoCov">          0 :             value = [(JSONModel*)value toDictionary];</span>
<span class="lineNum">     967 </span><span class="lineNoCov">          0 :             [tempDictionary setValue:value forKeyPath: keyPath];</span>
<span class="lineNum">     968 </span>            : 
<span class="lineNum">     969 </span>            :             //for clarity
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     971 </span>            : 
<span class="lineNum">     972 </span>            :         } else {
<span class="lineNum">     973 </span>            : 
<span class="lineNum">     974 </span>            :             // 1) check for built-in transformation
<span class="lineNum">     975 </span><span class="lineNoCov">          0 :             if (p.protocol) {</span>
<span class="lineNum">     976 </span><span class="lineNoCov">          0 :                 value = [self __reverseTransform:value forProperty:p];</span>
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">     978 </span>            : 
<span class="lineNum">     979 </span>            :             // 2) check for standard types OR 2.1) primitives
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :             if (p.structName==nil &amp;&amp; (p.isStandardJSONType || p.type==nil)) {</span>
<span class="lineNum">     981 </span>            : 
<span class="lineNum">     982 </span>            :                 //generic get value
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :                 [tempDictionary setValue:value forKeyPath: keyPath];</span>
<span class="lineNum">     984 </span>            : 
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :                 continue;</span>
<span class="lineNum">     986 </span>            :             }
<span class="lineNum">     987 </span>            : 
<span class="lineNum">     988 </span>            :             // 3) try to apply a value transformer
<span class="lineNum">     989 </span>            :             if (YES) {
<span class="lineNum">     990 </span>            : 
<span class="lineNum">     991 </span>            :                 //create selector from the property's class name
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :                 NSString* selectorName = [NSString stringWithFormat:@&quot;%@From%@:&quot;, @&quot;JSONObject&quot;, p.type?p.type:p.structName];</span>
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :                 SEL selector = NSSelectorFromString(selectorName);</span>
<span class="lineNum">     994 </span>            : 
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :                 BOOL foundCustomTransformer = NO;</span>
<span class="lineNum">     996 </span><span class="lineNoCov">          0 :                 if ([valueTransformer respondsToSelector:selector]) {</span>
<span class="lineNum">     997 </span><span class="lineNoCov">          0 :                     foundCustomTransformer = YES;</span>
<span class="lineNum">     998 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">     999 </span>            :                     //try for hidden transformer
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :                     selectorName = [NSString stringWithFormat:@&quot;__%@&quot;,selectorName];</span>
<span class="lineNum">    1001 </span><span class="lineNoCov">          0 :                     selector = NSSelectorFromString(selectorName);</span>
<span class="lineNum">    1002 </span><span class="lineNoCov">          0 :                     if ([valueTransformer respondsToSelector:selector]) {</span>
<span class="lineNum">    1003 </span><span class="lineNoCov">          0 :                         foundCustomTransformer = YES;</span>
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :                     }</span>
<span class="lineNum">    1005 </span>            :                 }
<span class="lineNum">    1006 </span>            : 
<span class="lineNum">    1007 </span>            :                 //check if there's a transformer declared
<span class="lineNum">    1008 </span><span class="lineNoCov">          0 :                 if (foundCustomTransformer) {</span>
<span class="lineNum">    1009 </span><span class="lineNoCov">          0 :                     IMP imp = [valueTransformer methodForSelector:selector];</span>
<span class="lineNum">    1010 </span><span class="lineNoCov">          0 :                     id (*func)(id, SEL, id) = (void *)imp;</span>
<span class="lineNum">    1011 </span><span class="lineNoCov">          0 :                     value = func(valueTransformer, selector, value);</span>
<span class="lineNum">    1012 </span>            : 
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 :                     [tempDictionary setValue:value forKeyPath:keyPath];</span>
<span class="lineNum">    1014 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">    1015 </span>            :                     //in this case most probably a custom property was defined in a model
<span class="lineNum">    1016 </span>            :                     //but no default reverse transformer for it
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :                     @throw [NSException exceptionWithName:@&quot;Value transformer not found&quot;</span>
<span class="lineNum">    1018 </span><span class="lineNoCov">          0 :                                                    reason:[NSString stringWithFormat:@&quot;[JSONValueTransformer %@] not found&quot;, selectorName]</span>
<span class="lineNum">    1019 </span>            :                                                  userInfo:nil];
<span class="lineNum">    1020 </span>            :                     return nil;
<span class="lineNum">    1021 </span>            :                 }
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">    1023 </span>            :         }
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1025 </span>            : 
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :     return [tempDictionary copy];</span>
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 : }</span>
<a name="1028"><span class="lineNum">    1028 </span>            : </a>
<span class="lineNum">    1029 </span>            : //exports model to a dictionary and then to a JSON string
<span class="lineNum">    1030 </span>            : - (NSData *)toJSONDataWithKeys:(NSArray &lt;NSString *&gt; *)propertyNames
<span class="lineNum">    1031 </span>            : {
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :     NSData* jsonData = nil;</span>
<span class="lineNum">    1033 </span><span class="lineNoCov">          0 :     NSError* jsonError = nil;</span>
<span class="lineNum">    1034 </span>            : 
<span class="lineNum">    1035 </span>            :     @try {
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :         NSDictionary* dict = [self toDictionaryWithKeys:propertyNames];</span>
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 :         jsonData = [NSJSONSerialization dataWithJSONObject:dict options:kNilOptions error:&amp;jsonError];</span>
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :     @catch (NSException *exception) {</span>
<span class="lineNum">    1040 </span>            :         //this should not happen in properly design JSONModel
<span class="lineNum">    1041 </span>            :         //usually means there was no reverse transformer for a custom property
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :         JMLog(@&quot;EXCEPTION: %@&quot;, exception.description);</span>
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :         return nil;</span>
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1045 </span>            : 
<span class="lineNum">    1046 </span><span class="lineNoCov">          0 :     return jsonData;</span>
<a name="1047"><span class="lineNum">    1047 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1048 </span>            : 
<span class="lineNum">    1049 </span>            : - (NSString *)toJSONStringWithKeys:(NSArray &lt;NSString *&gt; *)propertyNames
<span class="lineNum">    1050 </span>            : {
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :     return [[NSString alloc] initWithData: [self toJSONDataWithKeys: propertyNames]</span>
<span class="lineNum">    1052 </span>            :                                  encoding: NSUTF8StringEncoding];
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1054 </span>            : 
<a name="1055"><span class="lineNum">    1055 </span>            : #pragma mark - import/export of lists</a>
<span class="lineNum">    1056 </span>            : //loop over an NSArray of JSON objects and turn them into models
<span class="lineNum">    1057 </span>            : +(NSMutableArray*)arrayOfModelsFromDictionaries:(NSArray*)array
<span class="lineNum">    1058 </span>            : {
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :     return [self arrayOfModelsFromDictionaries:array error:nil];</span>
<a name="1060"><span class="lineNum">    1060 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1061 </span>            : 
<span class="lineNum">    1062 </span>            : + (NSMutableArray *)arrayOfModelsFromData:(NSData *)data error:(NSError **)err
<span class="lineNum">    1063 </span>            : {
<span class="lineNum">    1064 </span><span class="lineNoCov">          0 :     id json = [NSJSONSerialization JSONObjectWithData:data options:kNilOptions error:err];</span>
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 :     if (!json || ![json isKindOfClass:[NSArray class]]) return nil;</span>
<span class="lineNum">    1066 </span>            : 
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :     return [self arrayOfModelsFromDictionaries:json error:err];</span>
<a name="1068"><span class="lineNum">    1068 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1069 </span>            : 
<span class="lineNum">    1070 </span>            : + (NSMutableArray *)arrayOfModelsFromString:(NSString *)string error:(NSError **)err
<span class="lineNum">    1071 </span>            : {
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :     return [self arrayOfModelsFromData:[string dataUsingEncoding:NSUTF8StringEncoding] error:err];</span>
<span class="lineNum">    1073 </span><span class="lineNoCov">          0 : }</span>
<a name="1074"><span class="lineNum">    1074 </span>            : </a>
<span class="lineNum">    1075 </span>            : // Same as above, but with error reporting
<span class="lineNum">    1076 </span>            : +(NSMutableArray*)arrayOfModelsFromDictionaries:(NSArray*)array error:(NSError**)err
<span class="lineNum">    1077 </span>            : {
<span class="lineNum">    1078 </span>            :     //bail early
<span class="lineNum">    1079 </span><span class="lineNoCov">          0 :     if (isNull(array)) return nil;</span>
<span class="lineNum">    1080 </span>            : 
<span class="lineNum">    1081 </span>            :     //parse dictionaries to objects
<span class="lineNum">    1082 </span><span class="lineNoCov">          0 :     NSMutableArray* list = [NSMutableArray arrayWithCapacity: [array count]];</span>
<span class="lineNum">    1083 </span>            : 
<span class="lineNum">    1084 </span><span class="lineNoCov">          0 :     for (id d in array)</span>
<span class="lineNum">    1085 </span>            :     {
<span class="lineNum">    1086 </span><span class="lineNoCov">          0 :         if ([d isKindOfClass:NSDictionary.class])</span>
<span class="lineNum">    1087 </span>            :         {
<span class="lineNum">    1088 </span><span class="lineNoCov">          0 :             JSONModelError* initErr = nil;</span>
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 :             id obj = [[self alloc] initWithDictionary:d error:&amp;initErr];</span>
<span class="lineNum">    1090 </span><span class="lineNoCov">          0 :             if (obj == nil)</span>
<span class="lineNum">    1091 </span>            :             {
<span class="lineNum">    1092 </span>            :                 // Propagate the error, including the array index as the key-path component
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :                 if((err != nil) &amp;&amp; (initErr != nil))</span>
<span class="lineNum">    1094 </span>            :                 {
<span class="lineNum">    1095 </span><span class="lineNoCov">          0 :                     NSString* path = [NSString stringWithFormat:@&quot;[%lu]&quot;, (unsigned long)list.count];</span>
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 :                     *err = [initErr errorByPrependingKeyPathComponent:path];</span>
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1098 </span><span class="lineNoCov">          0 :                 return nil;</span>
<span class="lineNum">    1099 </span>            :             }
<span class="lineNum">    1100 </span>            : 
<span class="lineNum">    1101 </span><span class="lineNoCov">          0 :             [list addObject: obj];</span>
<span class="lineNum">    1102 </span><span class="lineNoCov">          0 :         } else if ([d isKindOfClass:NSArray.class])</span>
<span class="lineNum">    1103 </span>            :         {
<span class="lineNum">    1104 </span><span class="lineNoCov">          0 :             [list addObjectsFromArray:[self arrayOfModelsFromDictionaries:d error:err]];</span>
<span class="lineNum">    1105 </span><span class="lineNoCov">          0 :         } else</span>
<span class="lineNum">    1106 </span>            :         {
<span class="lineNum">    1107 </span>            :             // This is very bad
<span class="lineNum">    1108 </span>            :         }
<span class="lineNum">    1109 </span>            : 
<span class="lineNum">    1110 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1111 </span>            : 
<span class="lineNum">    1112 </span><span class="lineNoCov">          0 :     return list;</span>
<a name="1113"><span class="lineNum">    1113 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1114 </span>            : 
<span class="lineNum">    1115 </span>            : + (NSMutableDictionary *)dictionaryOfModelsFromString:(NSString *)string error:(NSError **)err
<span class="lineNum">    1116 </span>            : {
<span class="lineNum">    1117 </span><span class="lineNoCov">          0 :     return [self dictionaryOfModelsFromData:[string dataUsingEncoding:NSUTF8StringEncoding] error:err];</span>
<a name="1118"><span class="lineNum">    1118 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1119 </span>            : 
<span class="lineNum">    1120 </span>            : + (NSMutableDictionary *)dictionaryOfModelsFromData:(NSData *)data error:(NSError **)err
<span class="lineNum">    1121 </span>            : {
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :     id json = [NSJSONSerialization JSONObjectWithData:data options:kNilOptions error:err];</span>
<span class="lineNum">    1123 </span><span class="lineNoCov">          0 :     if (!json || ![json isKindOfClass:[NSDictionary class]]) return nil;</span>
<span class="lineNum">    1124 </span>            : 
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :     return [self dictionaryOfModelsFromDictionary:json error:err];</span>
<a name="1126"><span class="lineNum">    1126 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1127 </span>            : 
<span class="lineNum">    1128 </span>            : + (NSMutableDictionary *)dictionaryOfModelsFromDictionary:(NSDictionary *)dictionary error:(NSError **)err
<span class="lineNum">    1129 </span>            : {
<span class="lineNum">    1130 </span><span class="lineNoCov">          0 :     NSMutableDictionary *output = [NSMutableDictionary dictionaryWithCapacity:dictionary.count];</span>
<span class="lineNum">    1131 </span>            : 
<span class="lineNum">    1132 </span><span class="lineNoCov">          0 :     for (NSString *key in dictionary.allKeys)</span>
<span class="lineNum">    1133 </span>            :     {
<span class="lineNum">    1134 </span><span class="lineNoCov">          0 :         id object = dictionary[key];</span>
<span class="lineNum">    1135 </span>            : 
<span class="lineNum">    1136 </span><span class="lineNoCov">          0 :         if ([object isKindOfClass:NSDictionary.class])</span>
<span class="lineNum">    1137 </span>            :         {
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 :             id obj = [[self alloc] initWithDictionary:object error:err];</span>
<span class="lineNum">    1139 </span><span class="lineNoCov">          0 :             if (obj == nil) return nil;</span>
<span class="lineNum">    1140 </span><span class="lineNoCov">          0 :             output[key] = obj;</span>
<span class="lineNum">    1141 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1142 </span><span class="lineNoCov">          0 :         else if ([object isKindOfClass:NSArray.class])</span>
<span class="lineNum">    1143 </span>            :         {
<span class="lineNum">    1144 </span><span class="lineNoCov">          0 :             id obj = [self arrayOfModelsFromDictionaries:object error:err];</span>
<span class="lineNum">    1145 </span><span class="lineNoCov">          0 :             if (obj == nil) return nil;</span>
<span class="lineNum">    1146 </span><span class="lineNoCov">          0 :             output[key] = obj;</span>
<span class="lineNum">    1147 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1148 </span>            :         else
<span class="lineNum">    1149 </span>            :         {
<span class="lineNum">    1150 </span><span class="lineNoCov">          0 :             if (err) {</span>
<span class="lineNum">    1151 </span><span class="lineNoCov">          0 :                 *err = [JSONModelError errorInvalidDataWithTypeMismatch:@&quot;Only dictionaries and arrays are supported&quot;];</span>
<span class="lineNum">    1152 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">    1153 </span><span class="lineNoCov">          0 :             return nil;</span>
<span class="lineNum">    1154 </span>            :         }
<span class="lineNum">    1155 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1156 </span>            : 
<span class="lineNum">    1157 </span><span class="lineNoCov">          0 :     return output;</span>
<span class="lineNum">    1158 </span><span class="lineNoCov">          0 : }</span>
<a name="1159"><span class="lineNum">    1159 </span>            : </a>
<span class="lineNum">    1160 </span>            : //loop over NSArray of models and export them to JSON objects
<span class="lineNum">    1161 </span>            : +(NSMutableArray*)arrayOfDictionariesFromModels:(NSArray*)array
<span class="lineNum">    1162 </span>            : {
<span class="lineNum">    1163 </span>            :     //bail early
<span class="lineNum">    1164 </span><span class="lineNoCov">          0 :     if (isNull(array)) return nil;</span>
<span class="lineNum">    1165 </span>            : 
<span class="lineNum">    1166 </span>            :     //convert to dictionaries
<span class="lineNum">    1167 </span><span class="lineNoCov">          0 :     NSMutableArray* list = [NSMutableArray arrayWithCapacity: [array count]];</span>
<span class="lineNum">    1168 </span>            : 
<span class="lineNum">    1169 </span><span class="lineNoCov">          0 :     for (id&lt;AbstractJSONModelProtocol&gt; object in array) {</span>
<span class="lineNum">    1170 </span>            : 
<span class="lineNum">    1171 </span><span class="lineNoCov">          0 :         id obj = [object toDictionary];</span>
<span class="lineNum">    1172 </span><span class="lineNoCov">          0 :         if (!obj) return nil;</span>
<span class="lineNum">    1173 </span>            : 
<span class="lineNum">    1174 </span><span class="lineNoCov">          0 :         [list addObject: obj];</span>
<span class="lineNum">    1175 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1176 </span><span class="lineNoCov">          0 :     return list;</span>
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 : }</span>
<a name="1178"><span class="lineNum">    1178 </span>            : </a>
<span class="lineNum">    1179 </span>            : //loop over NSArray of models and export them to JSON objects with specific properties
<span class="lineNum">    1180 </span>            : +(NSMutableArray*)arrayOfDictionariesFromModels:(NSArray*)array propertyNamesToExport:(NSArray*)propertyNamesToExport;
<span class="lineNum">    1181 </span>            : {
<span class="lineNum">    1182 </span>            :     //bail early
<span class="lineNum">    1183 </span><span class="lineNoCov">          0 :     if (isNull(array)) return nil;</span>
<span class="lineNum">    1184 </span>            : 
<span class="lineNum">    1185 </span>            :     //convert to dictionaries
<span class="lineNum">    1186 </span><span class="lineNoCov">          0 :     NSMutableArray* list = [NSMutableArray arrayWithCapacity: [array count]];</span>
<span class="lineNum">    1187 </span>            : 
<span class="lineNum">    1188 </span><span class="lineNoCov">          0 :     for (id&lt;AbstractJSONModelProtocol&gt; object in array) {</span>
<span class="lineNum">    1189 </span>            : 
<span class="lineNum">    1190 </span><span class="lineNoCov">          0 :         id obj = [object toDictionaryWithKeys:propertyNamesToExport];</span>
<span class="lineNum">    1191 </span><span class="lineNoCov">          0 :         if (!obj) return nil;</span>
<span class="lineNum">    1192 </span>            : 
<span class="lineNum">    1193 </span><span class="lineNoCov">          0 :         [list addObject: obj];</span>
<span class="lineNum">    1194 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 :     return list;</span>
<a name="1196"><span class="lineNum">    1196 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1197 </span>            : 
<span class="lineNum">    1198 </span>            : +(NSMutableDictionary *)dictionaryOfDictionariesFromModels:(NSDictionary *)dictionary
<span class="lineNum">    1199 </span>            : {
<span class="lineNum">    1200 </span>            :     //bail early
<span class="lineNum">    1201 </span><span class="lineNoCov">          0 :     if (isNull(dictionary)) return nil;</span>
<span class="lineNum">    1202 </span>            : 
<span class="lineNum">    1203 </span><span class="lineNoCov">          0 :     NSMutableDictionary *output = [NSMutableDictionary dictionaryWithCapacity:dictionary.count];</span>
<span class="lineNum">    1204 </span>            : 
<span class="lineNum">    1205 </span><span class="lineNoCov">          0 :     for (NSString *key in dictionary.allKeys) {</span>
<span class="lineNum">    1206 </span><span class="lineNoCov">          0 :         id &lt;AbstractJSONModelProtocol&gt; object = dictionary[key];</span>
<span class="lineNum">    1207 </span><span class="lineNoCov">          0 :         id obj = [object toDictionary];</span>
<span class="lineNum">    1208 </span><span class="lineNoCov">          0 :         if (!obj) return nil;</span>
<span class="lineNum">    1209 </span><span class="lineNoCov">          0 :         output[key] = obj;</span>
<span class="lineNum">    1210 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1211 </span>            : 
<span class="lineNum">    1212 </span><span class="lineNoCov">          0 :     return output;</span>
<span class="lineNum">    1213 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1214 </span>            : 
<span class="lineNum">    1215 </span>            : #pragma mark - custom comparison methods
<span class="lineNum">    1216 </span>            : 
<a name="1217"><span class="lineNum">    1217 </span>            : #pragma GCC diagnostic push</a>
<span class="lineNum">    1218 </span>            : #pragma GCC diagnostic ignored &quot;-Wdeprecated-declarations&quot;
<span class="lineNum">    1219 </span>            : -(NSString*)indexPropertyName
<span class="lineNum">    1220 </span>            : {
<span class="lineNum">    1221 </span>            :     //custom getter for an associated object
<span class="lineNum">    1222 </span><span class="lineNoCov">          0 :     return objc_getAssociatedObject(self.class, &amp;kIndexPropertyNameKey);</span>
<a name="1223"><span class="lineNum">    1223 </span>            : }</a>
<span class="lineNum">    1224 </span>            : 
<span class="lineNum">    1225 </span>            : -(BOOL)isEqual:(id)object
<span class="lineNum">    1226 </span>            : {
<span class="lineNum">    1227 </span>            :     //bail early if different classes
<span class="lineNum">    1228 </span><span class="lineNoCov">          0 :     if (![object isMemberOfClass:[self class]]) return NO;</span>
<span class="lineNum">    1229 </span>            : 
<span class="lineNum">    1230 </span><span class="lineNoCov">          0 :     if (self.indexPropertyName) {</span>
<span class="lineNum">    1231 </span>            :         //there's a defined ID property
<span class="lineNum">    1232 </span><span class="lineNoCov">          0 :         id objectId = [object valueForKey: self.indexPropertyName];</span>
<span class="lineNum">    1233 </span><span class="lineNoCov">          0 :         return [[self valueForKey: self.indexPropertyName] isEqual:objectId];</span>
<span class="lineNum">    1234 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1235 </span>            : 
<span class="lineNum">    1236 </span>            :     //default isEqual implementation
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :     return [super isEqual:object];</span>
<a name="1238"><span class="lineNum">    1238 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1239 </span>            : 
<span class="lineNum">    1240 </span>            : -(NSComparisonResult)compare:(id)object
<span class="lineNum">    1241 </span>            : {
<span class="lineNum">    1242 </span><span class="lineNoCov">          0 :     if (self.indexPropertyName) {</span>
<span class="lineNum">    1243 </span><span class="lineNoCov">          0 :         id objectId = [object valueForKey: self.indexPropertyName];</span>
<span class="lineNum">    1244 </span><span class="lineNoCov">          0 :         if ([objectId respondsToSelector:@selector(compare:)]) {</span>
<span class="lineNum">    1245 </span><span class="lineNoCov">          0 :             return [[self valueForKey:self.indexPropertyName] compare:objectId];</span>
<span class="lineNum">    1246 </span>            :         }
<span class="lineNum">    1247 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1248 </span>            : 
<span class="lineNum">    1249 </span>            :     //on purpose postponing the asserts for speed optimization
<span class="lineNum">    1250 </span>            :     //these should not happen anyway in production conditions
<span class="lineNum">    1251 </span><span class="lineNoCov">          0 :     NSAssert(self.indexPropertyName, @&quot;Can't compare models with no &lt;Index&gt; property&quot;);</span>
<span class="lineNum">    1252 </span><span class="lineNoCov">          0 :     NSAssert1(NO, @&quot;The &lt;Index&gt; property of %@ is not comparable class.&quot;, [self class]);</span>
<span class="lineNum">    1253 </span><span class="lineNoCov">          0 :     return kNilOptions;</span>
<a name="1254"><span class="lineNum">    1254 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1255 </span>            : 
<span class="lineNum">    1256 </span>            : - (NSUInteger)hash
<span class="lineNum">    1257 </span>            : {
<span class="lineNum">    1258 </span><span class="lineNoCov">          0 :     if (self.indexPropertyName) {</span>
<span class="lineNum">    1259 </span><span class="lineNoCov">          0 :         id val = [self valueForKey:self.indexPropertyName];</span>
<span class="lineNum">    1260 </span>            : 
<span class="lineNum">    1261 </span><span class="lineNoCov">          0 :         if (val) {</span>
<span class="lineNum">    1262 </span><span class="lineNoCov">          0 :             return [val hash];</span>
<span class="lineNum">    1263 </span>            :         }
<span class="lineNum">    1264 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1265 </span>            : 
<span class="lineNum">    1266 </span><span class="lineNoCov">          0 :     return [super hash];</span>
<span class="lineNum">    1267 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1268 </span>            : 
<span class="lineNum">    1269 </span>            : #pragma GCC diagnostic pop
<a name="1270"><span class="lineNum">    1270 </span>            : </a>
<span class="lineNum">    1271 </span>            : #pragma mark - custom data validation
<span class="lineNum">    1272 </span>            : -(BOOL)validate:(NSError**)error
<span class="lineNum">    1273 </span>            : {
<span class="lineNum">    1274 </span><span class="lineNoCov">          0 :     return YES;</span>
<span class="lineNum">    1275 </span>            : }
<span class="lineNum">    1276 </span>            : 
<a name="1277"><span class="lineNum">    1277 </span>            : #pragma mark - custom recursive description</a>
<span class="lineNum">    1278 </span>            : //custom description method for debugging purposes
<span class="lineNum">    1279 </span>            : -(NSString*)description
<span class="lineNum">    1280 </span>            : {
<span class="lineNum">    1281 </span><span class="lineNoCov">          0 :     NSMutableString* text = [NSMutableString stringWithFormat:@&quot;&lt;%@&gt; \n&quot;, [self class]];</span>
<span class="lineNum">    1282 </span>            : 
<span class="lineNum">    1283 </span><span class="lineNoCov">          0 :     for (JSONModelClassProperty *p in [self __properties__]) {</span>
<span class="lineNum">    1284 </span>            : 
<span class="lineNum">    1285 </span><span class="lineNoCov">          0 :         id value = ([p.name isEqualToString:@&quot;description&quot;])?self-&gt;_description:[self valueForKey:p.name];</span>
<span class="lineNum">    1286 </span><span class="lineNoCov">          0 :         NSString* valueDescription = (value)?[value description]:@&quot;&lt;nil&gt;&quot;;</span>
<span class="lineNum">    1287 </span>            : 
<span class="lineNum">    1288 </span><span class="lineNoCov">          0 :         if (p.isStandardJSONType &amp;&amp; ![value respondsToSelector:@selector(count)] &amp;&amp; [valueDescription length]&gt;60) {</span>
<span class="lineNum">    1289 </span>            : 
<span class="lineNum">    1290 </span>            :             //cap description for longer values
<span class="lineNum">    1291 </span><span class="lineNoCov">          0 :             valueDescription = [NSString stringWithFormat:@&quot;%@...&quot;, [valueDescription substringToIndex:59]];</span>
<span class="lineNum">    1292 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1293 </span><span class="lineNoCov">          0 :         valueDescription = [valueDescription stringByReplacingOccurrencesOfString:@&quot;\n&quot; withString:@&quot;\n   &quot;];</span>
<span class="lineNum">    1294 </span><span class="lineNoCov">          0 :         [text appendFormat:@&quot;   [%@]: %@\n&quot;, p.name, valueDescription];</span>
<span class="lineNum">    1295 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1296 </span>            : 
<span class="lineNum">    1297 </span><span class="lineNoCov">          0 :     [text appendFormat:@&quot;&lt;/%@&gt;&quot;, [self class]];</span>
<span class="lineNum">    1298 </span><span class="lineNoCov">          0 :     return text;</span>
<span class="lineNum">    1299 </span><span class="lineNoCov">          0 : }</span>
<a name="1300"><span class="lineNum">    1300 </span>            : </a>
<span class="lineNum">    1301 </span>            : #pragma mark - key mapping
<span class="lineNum">    1302 </span>            : +(JSONKeyMapper*)keyMapper
<span class="lineNum">    1303 </span>            : {
<span class="lineNum">    1304 </span><span class="lineNoCov">          0 :     return nil;</span>
<a name="1305"><span class="lineNum">    1305 </span>            : }</a>
<span class="lineNum">    1306 </span>            : 
<span class="lineNum">    1307 </span>            : +(void)setGlobalKeyMapper:(JSONKeyMapper*)globalKeyMapperParam
<span class="lineNum">    1308 </span>            : {
<span class="lineNum">    1309 </span><span class="lineNoCov">          0 :     globalKeyMapper = globalKeyMapperParam;</span>
<a name="1310"><span class="lineNum">    1310 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1311 </span>            : 
<span class="lineNum">    1312 </span>            : +(BOOL)propertyIsOptional:(NSString*)propertyName
<span class="lineNum">    1313 </span>            : {
<span class="lineNum">    1314 </span>            :     return NO;
<a name="1315"><span class="lineNum">    1315 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1316 </span>            : 
<span class="lineNum">    1317 </span>            : +(BOOL)propertyIsIgnored:(NSString *)propertyName
<span class="lineNum">    1318 </span>            : {
<span class="lineNum">    1319 </span>            :     return NO;
<a name="1320"><span class="lineNum">    1320 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1321 </span>            : 
<span class="lineNum">    1322 </span>            : +(NSString*)protocolForArrayProperty:(NSString *)propertyName
<span class="lineNum">    1323 </span>            : {
<span class="lineNum">    1324 </span>            :     return nil;
<a name="1325"><span class="lineNum">    1325 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1326 </span>            : 
<span class="lineNum">    1327 </span>            : +(Class)classForCollectionProperty:(NSString *)propertyName
<span class="lineNum">    1328 </span>            : {
<span class="lineNum">    1329 </span>            : #pragma GCC diagnostic push
<span class="lineNum">    1330 </span>            : #pragma GCC diagnostic ignored &quot;-Wdeprecated-declarations&quot;
<span class="lineNum">    1331 </span><span class="lineNoCov">          0 :     NSString *protocolName = [self protocolForArrayProperty:propertyName];</span>
<span class="lineNum">    1332 </span>            : #pragma GCC diagnostic pop
<span class="lineNum">    1333 </span>            : 
<span class="lineNum">    1334 </span><span class="lineNoCov">          0 :     if (!protocolName)</span>
<span class="lineNum">    1335 </span><span class="lineNoCov">          0 :         return nil;</span>
<span class="lineNum">    1336 </span>            : 
<span class="lineNum">    1337 </span><span class="lineNoCov">          0 :     return NSClassFromString(protocolName);</span>
<span class="lineNum">    1338 </span><span class="lineNoCov">          0 : }</span>
<a name="1339"><span class="lineNum">    1339 </span>            : </a>
<span class="lineNum">    1340 </span>            : #pragma mark - working with incomplete models
<span class="lineNum">    1341 </span>            : - (void)mergeFromDictionary:(NSDictionary *)dict useKeyMapping:(BOOL)useKeyMapping
<span class="lineNum">    1342 </span>            : {
<span class="lineNum">    1343 </span><span class="lineNoCov">          0 :     [self mergeFromDictionary:dict useKeyMapping:useKeyMapping error:nil];</span>
<a name="1344"><span class="lineNum">    1344 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1345 </span>            : 
<span class="lineNum">    1346 </span>            : - (BOOL)mergeFromDictionary:(NSDictionary *)dict useKeyMapping:(BOOL)useKeyMapping error:(NSError **)error
<span class="lineNum">    1347 </span>            : {
<span class="lineNum">    1348 </span><span class="lineNoCov">          0 :     return [self __importDictionary:dict withKeyMapper:(useKeyMapping)? self.__keyMapper:nil validation:NO error:error];</span>
<span class="lineNum">    1349 </span><span class="lineNoCov">          0 : }</span>
<a name="1350"><span class="lineNum">    1350 </span>            : </a>
<span class="lineNum">    1351 </span>            : #pragma mark - NSCopying, NSCoding
<span class="lineNum">    1352 </span>            : -(instancetype)copyWithZone:(NSZone *)zone
<span class="lineNum">    1353 </span>            : {
<span class="lineNum">    1354 </span><span class="lineNoCov">          0 :     return [NSKeyedUnarchiver unarchiveObjectWithData:</span>
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :         [NSKeyedArchiver archivedDataWithRootObject:self]</span>
<span class="lineNum">    1356 </span>            :      ];
<a name="1357"><span class="lineNum">    1357 </span>            : }</a>
<span class="lineNum">    1358 </span>            : 
<span class="lineNum">    1359 </span>            : -(instancetype)initWithCoder:(NSCoder *)decoder
<span class="lineNum">    1360 </span>            : {
<span class="lineNum">    1361 </span><span class="lineNoCov">          0 :     NSString* json;</span>
<span class="lineNum">    1362 </span>            : 
<span class="lineNum">    1363 </span><span class="lineNoCov">          0 :     if ([decoder respondsToSelector:@selector(decodeObjectOfClass:forKey:)]) {</span>
<span class="lineNum">    1364 </span><span class="lineNoCov">          0 :         json = [decoder decodeObjectOfClass:[NSString class] forKey:@&quot;json&quot;];</span>
<span class="lineNum">    1365 </span><span class="lineNoCov">          0 :     } else {</span>
<span class="lineNum">    1366 </span><span class="lineNoCov">          0 :         json = [decoder decodeObjectForKey:@&quot;json&quot;];</span>
<span class="lineNum">    1367 </span>            :     }
<span class="lineNum">    1368 </span>            : 
<span class="lineNum">    1369 </span><span class="lineNoCov">          0 :     JSONModelError *error = nil;</span>
<span class="lineNum">    1370 </span><span class="lineNoCov">          0 :     self = [self initWithString:json error:&amp;error];</span>
<span class="lineNum">    1371 </span><span class="lineNoCov">          0 :     if (error) {</span>
<span class="lineNum">    1372 </span><span class="lineNoCov">          0 :         JMLog(@&quot;%@&quot;,[error localizedDescription]);</span>
<span class="lineNum">    1373 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1374 </span><span class="lineNoCov">          0 :     return self;</span>
<a name="1375"><span class="lineNum">    1375 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1376 </span>            : 
<span class="lineNum">    1377 </span>            : -(void)encodeWithCoder:(NSCoder *)encoder
<span class="lineNum">    1378 </span>            : {
<span class="lineNum">    1379 </span><span class="lineNoCov">          0 :     [encoder encodeObject:self.toJSONString forKey:@&quot;json&quot;];</span>
<a name="1380"><span class="lineNum">    1380 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1381 </span>            : 
<span class="lineNum">    1382 </span>            : + (BOOL)supportsSecureCoding
<span class="lineNum">    1383 </span>            : {
<span class="lineNum">    1384 </span><span class="lineNoCov">          0 :     return YES;</span>
<span class="lineNum">    1385 </span>            : }
<span class="lineNum">    1386 </span>            : 
<span class="lineNum">    1387 </span>            : @end
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
